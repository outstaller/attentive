name: Publish Updates to GitHub Pages

on:
  workflow_run:
    workflows: ["Release Installers (Teacher + Student)"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag to publish (e.g. v1.0.12)'
        required: true

jobs:
  publish-to-gh-pages:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Determine Tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "TAG_NAME=${{ github.event.inputs.tag_name }}" >> $GITHUB_ENV
          else
            echo "TAG_NAME=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_ENV
          fi

      - name: Create directories
        run: |
          mkdir -p gh-pages/update-manager/teacher
          mkdir -p gh-pages/update-manager/student

      - name: Download All Release Assets
        uses: robinraju/release-downloader@v1.9
        with:
          tag: ${{ env.TAG_NAME }}
          fileName: "*"
          out-file-path: "assets"

      - name: Organize Assets
        run: |
          echo "Organizing files for ${{ env.TAG_NAME }}..."
          
          # Function to enforce filename from latest.yml
          fix_filename() {
            local yml_file=$1
            local type_pattern=$2
            
            if [ -f "$yml_file" ]; then
              # Extract filename from path: key
              local expected_name=$(grep "^path:" "$yml_file" | sed 's/^path: //' | tr -d '\r')
              
              if [ -n "$expected_name" ]; then
                echo "Expected filename for $type_pattern: '$expected_name'"
                
                # Find the actual downloaded file
                local actual_file=$(find assets -name "*${type_pattern}*.exe" | head -n 1)
                
                if [ -n "$actual_file" ]; then
                  local dir=$(dirname "$actual_file")
                  local actual_basename=$(basename "$actual_file")
                  
                  # Rename if different
                  if [ "$actual_basename" != "$expected_name" ]; then
                     echo "Renaming '$actual_basename' to '$expected_name'"
                     mv "$actual_file" "$dir/$expected_name"
                  else
                     echo "Filename matches."
                  fi
                else
                  echo "No matching exe found for $type_pattern"
                fi
              else
                 echo "Could not extract path from $yml_file"
              fi
            fi
          }

          # Fix filenames in assets/ BEFORE moving
          fix_filename "assets/latest-teacher.yml" "Teacher"
          fix_filename "assets/latest-student.yml" "Student"

          # Teacher
          find assets -name "*Teacher*.exe" -exec mv {} gh-pages/update-manager/teacher/ \;
          find assets -name "*Teacher*.blockmap" -exec mv {} gh-pages/update-manager/teacher/ \;
          if [ -f "assets/latest-teacher.yml" ]; then
            mv assets/latest-teacher.yml gh-pages/update-manager/teacher/latest.yml
          fi

          # Student
          find assets -name "*Student*.exe" -exec mv {} gh-pages/update-manager/student/ \;
          find assets -name "*Student*.blockmap" -exec mv {} gh-pages/update-manager/student/ \;
          if [ -f "assets/latest-student.yml" ]; then
            mv assets/latest-student.yml gh-pages/update-manager/student/latest.yml
          fi

      - name: Commit and Push
        run: |
          cd gh-pages
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add .
          git commit -m "Update releases for version ${{ env.TAG_NAME }}"
          git push
